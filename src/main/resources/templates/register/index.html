<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" th:href="@{/webjars/bootstrap/5.3.0/css/bootstrap.min.css}">
	<title>ユーザー登録</title>
</head>
<body>
<div class="container">
	<img src="/images/logo.jpg" alt="Logo" style="width: 100px; height: auto;">
	<h2>ユーザー登録</h2>
	<form id="userForm" th:action="@{/register}" method="post">
		<div class="mb-3">
			<label for="name">ユーザー名</label>
			<input type="text" class="form-control" id="name" name="name">
		</div>
		<div class="mb-3">
			<label for="email">メールアドレス</label>
			<input type="email" class="form-control" id="email" name="email">
		</div>
		<div class="mb-3">
			<label for="password">パスワード</label>
			<input type="password" class="form-control" id="password" name="password">
		</div>
		<div class="mb-3">
			<label for="password_confirm">パスワードの確認</label>
			<input type="password" class="form-control" id="password_confirm" name="password_confirm">
		</div>
		<div class="mb-3">
			<label for="family_name">姓</label>
			<input type="text" class="form-control" id="family_name" name="family_name">
		</div>
		<div class="mb-3">
			<label for="first_name">名</label>
			<input type="text" class="form-control" id="first_name" name="first_name">
		</div>
		<div class="form-group">
            <label for="birthdate">生年月日</label>
            <input type="date" class="form-control" id="birthdate" name="birthdate" required>
        </div>
		<div class="form-group">
            <label for="age">年齢</label>
            <input type="text" class="form-control" id="age" name="age" readonly>
        </div>
		<div class="mb-3">
			<label for="gender">性別</label>
			<select class="form-control" id="gender" name="gender">
				<option value="">選択してください</option>
				<th:block th:each="gender : ${genderMap}">
					<option th:value="${gender.key}" th:text="${gender.value}"></option>
				</th:block>
			</select>
		</div>
		<div class="mb-3">
			<label for="profile_image">プロフィール画像</label>
			<input type="file" class="form-control" id="profile_image" name="profile_image">
		</div>
		<!-- 確認ボタンにクリックイベントを追加 -->
		<button type="button" class="btn btn-primary" onclick="showModal()">確認</button>
		<a th:href="@{/login}" class="btn btn-secondary">戻る</a>
	</form>
</div>

<!-- モーダルウィンドウのHTML -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalLabel">入力内容確認</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<p><strong>ユーザー名:</strong> <span id="modalName"></span></p>
				<p><strong>メールアドレス:</strong> <span id="modalEmail"></span></p>
				<p><strong>パスワード:</strong>セキュリティの観点から非表示にしています</p>
				<p><strong>姓:</strong> <span id="modalFamilyName"></span></p>
				<p><strong>名:</strong> <span id="modalFirstName"></span></p>
				<p><strong>年齢:</strong> <span id="modalAge"></span></p>
				<p><strong>性別:</strong> <span id="modalGender"></span></p>
				<div>
					<strong>プロフィール画像:</strong>
					<img id="modalProfileImage" src="" alt="プロフィール画像" style="max-width: 200px; height: auto; display: none;">
					<p id="modalProfileImageText"></p>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">戻る</button>
				<button type="button" class="btn btn-primary" onclick="submitForm()">登録</button>
			</div>
		</div>
	</div>
</div>

<script th:src="@{/webjars/popper.js/2.11.7/umd/popper.min.js}" defer></script>
<script th:src="@{/webjars/bootstrap/5.3.0/js/bootstrap.min.js}" defer></script>

<script>
	
	// 生年月日から年齢を計算
	document.getElementById('birthdate').addEventListener('change', function() {
        const birthdate = new Date(this.value);
        const today = new Date();
        const age = today.getFullYear() - birthdate.getFullYear();
        const monthDifference = today.getMonth() - birthdate.getMonth();
        if (monthDifference < 0 || (monthDifference === 0 && today.getDate() < birthdate.getDate())) {
            age--;
        }
        document.getElementById('age').value = age;
    });

	document.getElementById('profile_image').addEventListener('change', function(event) {
		const file = event.target.files[0];
		const reader = new FileReader();
		
		reader.onload = function(e) {
			const image = document.getElementById('modalProfileImage');
			image.src = e.target.result;
		};
		
		if (file) {
			reader.readAsDataURL(file);
		} else {
			// 画像が選択されていない場合
			document.getElementById('modalProfileImage').src = "";
			document.getElementById('modalProfileImage').alt = "画像選択なし";
			document.getElementById('modalProfileImage').style.display = "none";
			document.getElementById('modalProfileImageText').textContent = "画像選択なし";
		}
	});
	
	// 入力内容を取得してモーダルに表示
	function showModal() {
		// 各入力項目の値を取得
		document.getElementById("modalName").textContent = document.getElementById("name").value;
		document.getElementById("modalEmail").textContent = document.getElementById("email").value;
		document.getElementById("modalFamilyName").textContent = document.getElementById("family_name").value;
		document.getElementById("modalFirstName").textContent = document.getElementById("first_name").value;
		document.getElementById("modalAge").textContent = document.getElementById("age").value;
		
		// 性別
		const genderValue = document.getElementById("gender").value;
		let genderText = "";
		
		switch (genderValue) {
			case "1":
				genderText = "男性";
				break;
			case "2":
				genderText = "女性";
				break;
			case "3":
				genderText = "その他";
				break;
			case "4":
				genderText = "不明";
				break;
			default:
				genderText = "";
				break;
		}
		
		document.getElementById("modalGender").textContent = genderText;
		
		// プロフィール画像
		const profileImage = document.getElementById('profile_image').files[0];
		if (profileImage) {
			document.getElementById('modalProfileImage').src = URL.createObjectURL(profileImage);
			document.getElementById('modalProfileImage').style.display = "block";
			document.getElementById('modalProfileImageText').textContent = "";
		} else {
			document.getElementById('modalProfileImage').style.display = "none";
			document.getElementById('modalProfileImageText').textContent = "画像選択なし";
		}
		
		// モーダルを表示
		var confirmationModal = new bootstrap.Modal(document.getElementById("confirmationModal"));
		confirmationModal.show();
	}
	
	// フォームを送信
	function submitForm() {
		document.getElementById("userForm").submit();
	}
	
	// キャンセルボタン押下時の処理
	function cancelRegistration() {
		location.reload();
	}
</script>
</body>
</html>
